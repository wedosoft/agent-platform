<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공통 문서 검색 (Homepage Common)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 2rem; background-color: #f8f9fa; }
        .chat-container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .citation-box { background-color: #f1f3f5; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9em; }
        .citation-link { color: #0d6efd; text-decoration: none; }
        .citation-link:hover { text-decoration: underline; }
        .loading-spinner { display: none; }
    </style>
</head>
<body>

<div class="container chat-container">
    <h2 class="mb-4 text-center">Common Document Search</h2>
    
    <div class="mb-3">
        <label for="productSelect" class="form-label">제품 선택 (Filter)</label>
        <select class="form-select" id="productSelect">
            <option value="" selected>전체 제품</option>
            <!-- Products will be loaded here -->
        </select>
    </div>

    <div class="mb-3">
        <label for="queryInput" class="form-label">질문 내용</label>
        <div class="input-group">
            <input type="text" class="form-control" id="queryInput" placeholder="궁금한 점을 입력하세요 (예: 비밀번호 초기화 방법)">
            <button class="btn btn-primary" type="button" id="searchBtn">검색</button>
        </div>
    </div>

    <div class="d-flex justify-content-center my-3 loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="resultArea" style="display: none;">
        <hr>
        <h4>검색 결과</h4>
        <div id="responseText" class="mb-3" style="white-space: pre-wrap;"></div>
        
        <div id="citationsArea">
            <h5>참고 자료</h5>
            <div id="citationsList"></div>
        </div>
    </div>
    
    <div id="errorArea" class="alert alert-danger mt-3" style="display: none;"></div>
</div>

<script>
    const API_PREFIX = '/api'; // Adjust if needed based on deployment

    document.addEventListener('DOMContentLoaded', () => {
        fetchProducts();
        
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('queryInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });
    });

    async function fetchProducts() {
        try {
            const res = await fetch(`${API_PREFIX}/common-products`);
            if (!res.ok) throw new Error('제품 목록을 불러오는데 실패했습니다.');
            const data = await res.json();
            const select = document.getElementById('productSelect');
            
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                select.appendChild(option);
            });
        } catch (err) {
            console.error(err);
            showError('제품 목록 로드 실패: ' + err.message);
        }
    }

    async function performSearch() {
        const query = document.getElementById('queryInput').value.trim();
        const product = document.getElementById('productSelect').value;
        
        if (!query) {
            alert('질문을 입력해주세요.');
            return;
        }

        showLoading(true);
        hideResult();
        hideError();

        const payload = {
            sessionId: 'web-session-' + Date.now(), // Simple session ID generation
            query: query,
            product: product || null,
            // Using a default store name if backend requires it, 
            // but typically backend config defaults this if not provided or handled via common_chat_handler logic.
            // However, CommonChatHandler checks `ragStoreName` or `sources` matching store name.
            // Let's see logic: CommonChatHandler.can_handle checks `request.sources` vs `self.store_name`.
            // But if `sources` is empty, it returns True? 
            // No: `if not sources: return True`.
            // So we don't strictly need to send `sources` if we want CommonChatHandler to pick it up, 
            // BUT `TicketChatHandler` might pick it up if we are not careful?
            // `CommonChatHandler` is checked *before* `TicketChatHandler` in `chat` router if dependencies order matters?
            // In `router.py`: `common_handler` is checked first.
            // `if common_handler and common_handler.can_handle(request):`
            // `can_handle`: if sources is empty -> return True.
            // So it should work.
        };

        try {
            const res = await fetch(`${API_PREFIX}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.detail || '검색 중 오류가 발생했습니다.');
            }

            const data = await res.json();
            renderResult(data);

        } catch (err) {
            showError(err.message);
        } finally {
            showLoading(false);
        }
    }

    function renderResult(data) {
        const resultArea = document.getElementById('resultArea');
        const responseText = document.getElementById('responseText');
        const citationsList = document.getElementById('citationsList');

        responseText.textContent = data.text || "결과가 없습니다.";
        citationsList.innerHTML = '';

        if (data.groundingChunks && data.groundingChunks.length > 0) {
            data.groundingChunks.forEach(chunk => {
                const div = document.createElement('div');
                div.className = 'citation-box';
                
                let content = '';
                if (chunk.web) {
                    content = `<strong>[Web]</strong> <a href="${chunk.web.uri}" target="_blank" class="citation-link">${chunk.web.title || chunk.web.uri}</a>`;
                } else if (chunk.uri && chunk.title) {
                     content = `<strong>[Source]</strong> <a href="${chunk.uri}" target="_blank" class="citation-link">${chunk.title}</a>`;
                } else {
                    // Fallback for unstructured chunks
                    content = JSON.stringify(chunk);
                }
                div.innerHTML = content;
                citationsList.appendChild(div);
            });
        } else {
            citationsList.innerHTML = '<p class="text-muted">참고 자료가 없습니다.</p>';
        }

        resultArea.style.display = 'block';
    }

    function showLoading(isLoading) {
        document.getElementById('loadingSpinner').style.display = isLoading ? 'flex' : 'none';
        document.getElementById('searchBtn').disabled = isLoading;
    }

    function hideResult() {
        document.getElementById('resultArea').style.display = 'none';
    }

    function showError(msg) {
        const el = document.getElementById('errorArea');
        el.textContent = msg;
        el.style.display = 'block';
    }
    
    function hideError() {
        document.getElementById('errorArea').style.display = 'none';
    }
</script>

</body>
</html>
