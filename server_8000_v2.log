INFO:     Will watch for changes in these directories: ['/Users/alan/GitHub/agent-platform']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [41562] using WatchFiles
INFO:     Started server process [41621]
INFO:     Waiting for application startup.
2025-12-10 16:44:53,773 - apscheduler.scheduler - INFO - Scheduler started
2025-12-10 16:44:53,773 - app.services.scheduler_service - INFO - Ïä§ÏºÄÏ§ÑÎü¨ ÏãúÏûëÎê®
2025-12-10 16:44:53,773 - app.main - INFO - Scheduler started
2025-12-10 16:44:53,773 - apscheduler.scheduler - DEBUG - Looking for jobs to run
2025-12-10 16:44:53,773 - apscheduler.scheduler - DEBUG - No jobs; waiting until a job is added
INFO:     Application startup complete.
2025-12-10 16:45:01,661 - app.api.routes.assist - INFO - Analyze request for ticket 12345 (Tenant: test-tenant)
2025-12-10 16:45:01,663 - app.agents.retriever - INFO - Retrieving context via Gemini
2025-12-10 16:45:01,663 - app.services.gemini_file_search_client - INFO - üìù Conversation history: 0 turns
2025-12-10 16:45:01,663 - app.services.gemini_file_search_client - INFO -   [0] user: Test Ticket This is a test ticket description....
2025-12-10 16:45:01,663 - app.services.gemini_file_search_client - INFO - Built contents with 1 turns (history: 0)
2025-12-10 16:45:03,501 - app.agents.retriever - INFO - Context retrieval complete
2025-12-10 16:45:03,502 - app.agents.analyzer - INFO - Analyzing ticket
2025-12-10 16:45:03,957 - openai._base_client - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-2bfdd934-8a36-4e2e-9796-2d77ace6c555', 'json_data': {'messages': [{'role': 'system', 'content': '\n        You are an expert customer support analyzer. Analyze the ticket and return JSON with:\n        - intent: (inquiry, complaint, request, technical_issue)\n        - sentiment: (positive, neutral, negative, urgent)\n        - summary: 1-sentence summary in Korean\n        - key_entities: list of important entities\n        '}, {'role': 'user', 'content': '{"ticketId": "12345", "subject": "Test Ticket", "description": "This is a test ticket description.", "priority": null, "status": null, "tags": null, "streamProgress": false}'}], 'model': 'deepseek-chat', 'response_format': {'type': 'json_object'}, 'temperature': 0.3}}
2025-12-10 16:45:03,957 - openai._base_client - DEBUG - Sending HTTP Request: POST https://api.deepseek.com/chat/completions
2025-12-10 16:45:07,488 - openai._base_client - DEBUG - HTTP Response: POST https://api.deepseek.com/chat/completions "200 OK" Headers({'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'date': 'Wed, 10 Dec 2025 07:45:04 GMT', 'server': 'elb', 'content-encoding': 'gzip', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-credentials': 'true', 'x-ds-trace-id': '8cb0a87cc7bb5a4e86bee209de29067b', 'strict-transport-security': 'max-age=31536000; includeSubDomains; preload', 'x-content-type-options': 'nosniff', 'x-cache': 'Miss from cloudfront', 'via': '1.1 8d1c49cd4a0614933a92673a319c7faa.cloudfront.net (CloudFront)', 'x-amz-cf-pop': 'ICN57-P1', 'x-amz-cf-id': '01Re83KC2s-42ELr4UejU6uw6SLBuSwZ6wj8RRN20Ytuh0AT-7pCVg=='})
2025-12-10 16:45:07,489 - openai._base_client - DEBUG - request_id: None
2025-12-10 16:45:07,495 - app.agents.analyzer - INFO - Analysis complete: inquiry
2025-12-10 16:45:07,497 - app.agents.resolver - INFO - Proposing solution
2025-12-10 16:45:07,503 - openai._base_client - DEBUG - Request options: {'method': 'post', 'url': '/chat/completions', 'files': None, 'idempotency_key': 'stainless-python-retry-29dee971-e95c-4949-a3a3-82a20193200f', 'json_data': {'messages': [{'role': 'system', 'content': '\n        You are a helpful support agent. Based on the ticket and search results, \n        generate a response draft and suggest field updates.\n        \n        Return JSON with:\n        - draft_response: Polite, helpful response in Korean\n        - field_updates: { priority, status, type, tags } (only if changes needed)\n        - reasoning: Why you made these suggestions\n        '}, {'role': 'user', 'content': '{"ticket": {"ticketId": "12345", "subject": "Test Ticket", "description": "This is a test ticket description.", "priority": null, "status": null, "tags": null, "streamProgress": false}, "analysis": {"intent": "inquiry", "sentiment": "neutral", "summary": "ÌÖåÏä§Ìä∏ Ìã∞ÏºìÏóê ÎåÄÌïú ÏÑ§Î™ÖÏù¥ Ìè¨Ìï®Îêú ÏùºÎ∞òÏ†ÅÏù∏ Î¨∏ÏùòÏûÖÎãàÎã§.", "key_entities": ["Test Ticket", "test ticket description"]}, "similar_cases": [], "kb_articles": []}'}], 'model': 'deepseek-chat', 'response_format': {'type': 'json_object'}, 'temperature': 0.7}}
2025-12-10 16:45:07,503 - openai._base_client - DEBUG - Sending HTTP Request: POST https://api.deepseek.com/chat/completions
2025-12-10 16:45:17,510 - openai._base_client - DEBUG - HTTP Response: POST https://api.deepseek.com/chat/completions "200 OK" Headers({'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'date': 'Wed, 10 Dec 2025 07:45:07 GMT', 'server': 'elb', 'content-encoding': 'gzip', 'vary': 'origin, access-control-request-method, access-control-request-headers', 'access-control-allow-credentials': 'true', 'x-ds-trace-id': '7bbbcaa3266afc6789a1532bef4eaed7', 'strict-transport-security': 'max-age=31536000; includeSubDomains; preload', 'x-content-type-options': 'nosniff', 'x-cache': 'Miss from cloudfront', 'via': '1.1 a71a8b9de67e7f85c25619daebd4c7bc.cloudfront.net (CloudFront)', 'x-amz-cf-pop': 'ICN57-P1', 'x-amz-cf-id': 'KJEmqPk-LRDsdv25uFFS32KfU8L_W6gWE6AeNHbbos9cgsqd0p_O-A=='})
2025-12-10 16:45:17,510 - openai._base_client - DEBUG - request_id: None
2025-12-10 16:45:17,511 - app.agents.resolver - INFO - Solution proposed
2025-12-10 16:45:17,512 - app.agents.approval - INFO - Checking approval status
2025-12-10 16:45:17,512 - app.agents.approval - INFO - Auto-approved (MVP)
INFO:     127.0.0.1:51014 - "POST /api/assist/analyze HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 307, in connect_check_health
    await self.retry.call_with_retry(
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/retry.py", line 50, in call_with_retry
    return await do()
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 768, in _connect
    reader, writer = await asyncio.open_connection(
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 52, in open_connection
    transport, _ = await loop.create_connection(
  File "uvloop/loop.pyx", line 1982, in create_connection
socket.gaierror: [Errno 8] nodename nor servname provided, or not known

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1139, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/routing.py", line 120, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/routing.py", line 106, in app
    response = await f(request)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/routing.py", line 430, in app
    raw_response = await run_endpoint_function(
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/fastapi/routing.py", line 316, in run_endpoint_function
    return await dependant.call(**values)
  File "/Users/alan/GitHub/agent-platform/app/api/routes/assist.py", line 105, in analyze_ticket
    response = await build_analyze_response(final_state, repo, x_tenant_id, request.ticket_id)
  File "/Users/alan/GitHub/agent-platform/app/api/routes/assist.py", line 176, in build_analyze_response
    await repo.save_proposal(proposal_id, proposal)
  File "/Users/alan/GitHub/agent-platform/app/repositories/proposal_repository.py", line 26, in save_proposal
    await self.redis.setex(f"proposal:{proposal_id}", ttl_seconds, json.dumps(data))
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/client.py", line 720, in execute_command
    conn = self.connection or await pool.get_connection()
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 1198, in get_connection
    await self.ensure_connection(connection)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 1231, in ensure_connection
    await connection.connect()
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 298, in connect
    await self.connect_check_health(check_health=True)
  File "/Users/alan/GitHub/agent-platform/venv/lib/python3.9/site-packages/redis/asyncio/connection.py", line 317, in connect_check_health
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 8 connecting to fly-agent-platform-redis.upstash.io:6379. nodename nor servname provided, or not known.
WARNING:  WatchFiles detected changes in 'app/repositories/proposal_repository.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2025-12-10 16:45:44,097 - app.services.scheduler_service - INFO - Ïä§ÏºÄÏ§ÑÎü¨ Ï¢ÖÎ£åÎê®
2025-12-10 16:45:44,097 - app.main - INFO - Scheduler stopped
2025-12-10 16:45:44,097 - apscheduler.scheduler - INFO - Scheduler has been shut down
INFO:     Application shutdown complete.
INFO:     Finished server process [41621]
INFO:     Started server process [43237]
INFO:     Waiting for application startup.
2025-12-10 16:45:44,946 - apscheduler.scheduler - INFO - Scheduler started
2025-12-10 16:45:44,946 - app.services.scheduler_service - INFO - Ïä§ÏºÄÏ§ÑÎü¨ ÏãúÏûëÎê®
2025-12-10 16:45:44,946 - app.main - INFO - Scheduler started
2025-12-10 16:45:44,946 - apscheduler.scheduler - DEBUG - Looking for jobs to run
2025-12-10 16:45:44,946 - apscheduler.scheduler - DEBUG - No jobs; waiting until a job is added
INFO:     Application startup complete.
INFO:     Shutting down
INFO:     Waiting for application shutdown.
2025-12-10 16:45:51,926 - app.services.scheduler_service - INFO - Ïä§ÏºÄÏ§ÑÎü¨ Ï¢ÖÎ£åÎê®
2025-12-10 16:45:51,926 - app.main - INFO - Scheduler stopped
2025-12-10 16:45:51,926 - apscheduler.scheduler - INFO - Scheduler has been shut down
INFO:     Application shutdown complete.
INFO:     Finished server process [43237]
INFO:     Stopping reloader process [41562]
