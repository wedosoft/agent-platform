# PR11: FDK 채널 commonProduct 필수 + sources 조합 제한

## 배경

- FDK 채널 BFF(`/api/fdk/v1/*`)는 채널별 입력/출력 변환과 검증을 담당합니다.
- `sources`는 “어디를 검색할지”를 결정하는 입력이고, `commonProduct`는 “어떤 제품/도메인 문맥으로 검색할지”에 영향을 줍니다.
- 채널별 계약을 BFF 레이어에서 고정해야, 상위 클라이언트/채널에서 실수를 줄이고 데이터 흐름을 안정화할 수 있습니다.

## 정책

### 1) `commonProduct` 필수

- `/api/fdk/v1/chat` 및 `/api/fdk/v1/chat/stream`에서 `commonProduct`(또는 `product`)가 없거나 빈 문자열이면 **400**을 반환합니다.
- POST JSON에서는 `product` 또는 `commonProduct`를 모두 허용합니다(모델의 alias로 처리).
- GET stream에서는 query param `product` 또는 `commonProduct`를 모두 허용합니다(레거시 호환).

### 2) `ragStoreName` 허용(변경 없음)

- `ragStoreName`은 계속 optional로 허용합니다.

### 3) `sources` 조합 제한

- 기존 정책(PR9/PR10)인 `sources` 필수 + allowlist 검증은 유지합니다.
- 추가로 아래 조합 규칙을 적용합니다.
  - **논리 키 조합**: `tickets/articles/common`만으로 구성된 조합
    - 단, `common` **단독**은 금지(최소 `tickets` 또는 `articles` 포함)
  - **store name 조합**: 설정된 store name을 사용할 경우 **1개만** 허용(다른 sources와 혼용 금지)

## 에러 계약(400)

### commonProduct 누락

- `detail`은 JSON(dict) 형태
  - `error`: `"MISSING_COMMON_PRODUCT"`
  - `message`: `"FDK 채널에서는 commonProduct(product)가 필수입니다."`

### sources 조합 규칙 위반

- `detail`은 JSON(dict) 형태
  - `error`: `"INVALID_SOURCES_COMBINATION"`
  - `message`: 위반 사유
  - `sources`: 정규화(중복 제거/trim)된 sources 목록

## 구현 근거(파일)

- 검증 로직: `app/api/routes/channel_fdk_v1.py`
- 테스트: `tests/test_fdk_sources_required.py`, `tests/test_channel_bff_chat.py`

